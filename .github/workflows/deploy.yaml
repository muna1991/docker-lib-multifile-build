name: Build & Deploy with Slack Approval

on:
  push:
jobs:
  build:
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Image Tag
        id: meta
        run: echo "image_tag=backend-service:v12" >> $GITHUB_OUTPUT

      - name: Send Slack Approval Request
        uses: ./.github/actions/send-approval-slack
        with:
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
          image_tag: backend-service:v12

  wait_for_approval:
    needs: build
    runs-on: self-hosted
    outputs:
        status: ${{ steps.get_decision.outputs.status }}
    steps:
        - name: Poll Slack Decision from DynamoDB
          id: get_decision
          run: |
            image_tag="backend-service:v12"
            region="us-west-2"
            table="SlackApprovals"

            for i in {1..30}; do
            echo "üîÑ Attempt $i: Checking decision for $image_tag..."

            result=$(aws dynamodb get-item \
                --table-name "$table" \
                --key '{"image_tag": {"S": "'"$image_tag"'"}, "decision": {"S": "latest"}}' \
                --region "$region")

            status=$(echo "$result" | jq -r '.Item.status.S // empty')

            echo "Polled status: $status"

            if [[ "$status" == "approve" || "$status" == "reject" ]]; then
                echo "status=$status" >> $GITHUB_OUTPUT
                exit 0
            fi

            sleep 10
            done

            echo "‚ùå Timed out waiting for decision"
            echo "status=timeout" >> $GITHUB_OUTPUT
            exit 1

  push:
    needs: wait_for_approval
    if: needs.wait_for_approval.outputs.status == 'approve'
    runs-on: self-hosted
    steps:
      - name: Push Docker Image
        run: echo "‚úÖ Image approved. Pushing to ECR..."

  reject_handler:
    needs: wait_for_approval
    if: needs.wait_for_approval.outputs.status == 'reject'
    runs-on: self-hosted
    steps:
      - name: Stop Deployment
        run: echo "‚ùå Deployment rejected by Slack."
