name: Build & Deploy with Slack Approval

on:
  push:
    
jobs:
  build:
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set Image Tag
        id: meta
        run: echo "image_tag=backend-service:v12" >> $GITHUB_OUTPUT

      - name: Send Slack Approval Request
        uses: ./.github/actions/send-approval-slack
        with:
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
          image_tag: backend-service:v12

  wait_for_approval:
    needs: build
    runs-on: self-hosted
    outputs:
      decision: ${{ steps.get_decision.outputs.decision }}
    steps:
      - name: Poll Slack Decision
        id: get_decision
        run: |
          for i in {1..30}; do
            decision=$(aws dynamodb query \
              --table-name SlackApprovals \
              --key-condition-expression "image_tag = :tag" \
              --expression-attribute-values '{":tag":{"S":"backend-service:v12"}}' \
              --query 'Items[0].decision.S' \
              --output text 2>/dev/null)

            echo "Polled Decision: $decision"

            if [[ "$decision" == "approve" || "$decision" == "reject" ]]; then
              echo "decision=$decision" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 10
          done

          echo "❌ Timed out waiting for approval"
          echo "decision=timeout" >> $GITHUB_OUTPUT
          exit 1

  push:
    needs: wait_for_approval
    if: needs.wait_for_approval.outputs.decision == 'approve'
    runs-on: self-hosted
    steps:
      - name: Push Docker Image
        run: echo "✅ Image approved. Pushing to ECR..."

  reject_handler:
    needs: wait_for_approval
    if: needs.wait_for_approval.outputs.decision == 'reject'
    runs-on: self-hosted
    steps:
      - name: Stop Deployment
        run: echo "❌ Deployment rejected by Slack."
