name: Multi-Env Docker CI/CD

on:
  push:
    branches:
      - main

jobs:
  detect-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Environment Matrix
        id: set-matrix
        run: |
          MATRIX='{"env":["dev", "qa", "uat", "prod"]}'
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: detect-updates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-updates.outputs.matrix).env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          echo "Building image for ${{ matrix.environment }}"
          docker build -t myrepo/${{ matrix.environment }}:latest .

  scan:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-updates.outputs.matrix).env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy Scan
        id: trivy_scan
        continue-on-error: true  # Won't stop pipeline on failure
        run: |
          echo "Scanning image for ${{ matrix.environment }}"
          trivy image myrepo/${{ matrix.environment }}:latest > scan_results.txt || true

      - name: Check User Input for Approval
        run: |
          if [[ "${{ env.skip_vulnerability }}" == "true" ]]; then
            echo "Skipping vulnerability check based on user input."
          elif grep -q "HIGH\|CRITICAL" scan_results.txt; then
            echo "Vulnerabilities found! Exiting."
            exit 1
          fi

  push:
    needs: scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-updates.outputs.matrix).env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Push Docker Image
        run: |
          echo "Pushing image for ${{ matrix.environment }}"
          docker tag myrepo/${{ matrix.environment }}:latest myrepo/${{ matrix.environment }}:latest
          docker push myrepo/${{ matrix.environment }}:latest
